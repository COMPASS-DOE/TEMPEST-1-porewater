---
title: "figures"
author: "AMP"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
getwd()
```

```{r event and study dates}
endstudydate = lubridate::as_date("2024-01-31")
startstudydate = lubridate::as_date("2022-05-01")

WaterDeliveryStart2022 = as.POSIXct("2022-06-22 05:30:00", tz = "EST")
WaterDeliveryStop2022 = as.POSIXct("2022-06-22 14:30:00", tz = "EST")

WaterDeliveryStart1 = as.POSIXct("2023-06-06 05:30:00", tz = "EST")
WaterDeliveryStop1 = as.POSIXct("2023-06-06 14:30:00", tz = "EST")

WaterDeliveryStart2 = as.POSIXct("2023-06-07 05:30:00", tz = "EST")
WaterDeliveryStop2 = as.POSIXct("2023-06-07 14:30:00", tz = "EST")
```

```{r load data}
pw_grids <- readRDS("./processed data/TMP_PW_GRIDSONLY_NPOC_TDN_L1_May2022-Dec2023.rds")

pw_pooled <- readRDS("./processed data/TMP_PW_POOL_NPOC_TDN_L1_May2022-Dec2023.rds")

eems_pooled <- readRDS("./processed data/TMP_PW_POOLED_CDOM_L1_May2022-Dec2023.rds")
eems_grids <- readRDS("./processed data/TMP_PW_grids_CDOM_L1_May2022-Dec2023.rds")

```

```{r prep data for plotting}

levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25)

pw_plotting <- pw_grids %>%
  filter(!is.na(doc_mg_l)) %>%
  filter(sample_name != "Lysimeter Empty") %>%
  select(doc_mg_l, tdn_mg_l, plot, Grid, date, time, datetime, Group) %>%
  dplyr::group_by(plot, Group) %>% 
    arrange(plot, date, time) 
  
```

  mutate(plotting_group= case_when(Group == "5-2022" ~ "1",
                                   Group == "2022-06-15" ~ "2",
                                   Group == "2022-06-20" ~ "2",
                                   Group == "2022-06-22" ~ "3", # Event Day
                                   Group == "2022-06-23" ~ "4",
                                   Group == "2022-06-24" ~ "5",
                                   Group == "7-2022" ~ "6",
                                   Group == "8-2022" ~ "7",
                                   Group == "9-2022" ~ "8",
                                   Group == "10-2022" ~ "9",
                                   Group == "11-2022" ~ "10",
                                   Group == "12-2022" ~ "11",
                                   Group == "2-2023" ~ "12",
                                   Group == "4-2023" ~ "13",
                                   Group == "5-2023" ~ "14",
                                   Group == "2023-06-03" ~ "15",
                                   Group == "2023-06-05" ~ "15", 
                                   Group == "2023-06-06" ~ "16", #Event Day
                                   Group == "2023-06-07" ~ "17", #Event Day
                                   Group == "2023-06-08" ~ "18", 
                                   Group == "2023-06-12" ~ "19",
                                   Group == "2023-06-14" ~ "19",
                                   Group == "2023-06-17" ~ "19",
                                   Group == "2023-06-27" ~ "20",
                                   Group == "2023-06-28" ~ "20",
                                   Group == "7-2023" ~ "21",
                                   Group == "8-2023" ~ "22",
                                   Group == "10-2023" ~ "23",
                                   Group == "11-2023" ~ "24",
                                   Group == "12-2023" ~ "25",
                                   TRUE ~ NA)) %>%
         mutate(plotting_group= factor(plotting_group, levels = levels))

all_the_doc <- pw2022event %>%
  full_join(pw2022) %>%
  full_join(pw2023) %>%
  mutate(date = as.POSIXct(date)) %>%
  mutate(Plot = stringr::str_replace(Plot,"SW","Estuarine-water Plot")) %>%
  mutate(Plot = stringr::str_replace(Plot,"FW","Freshwater Plot")) %>%
  mutate(Plot = stringr::str_replace(Plot,"C","Control Plot")) %>%
  mutate(date_formatted = paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date))) %>%
  mutate(date_formatted = lubridate::as_date(date_formatted)) %>%
  mutate(plot_date = case_when( lubridate::month(date_formatted) == lubridate::month(event_2023) ~ paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date)),
                               lubridate::month(date_formatted) == lubridate::month(event_2023) ~ paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date)),
          TRUE ~  paste0(lubridate::year(date), "-", lubridate::month(date), "-", "01")),
        month = lubridate::month(date),
        year = lubridate::year(date)) %>%
  mutate(plot_date = lubridate::with_tz(plot_date, "UTC")) %>%
  group_by(Plot, plot_date, month, year) %>% 
  filter(Grid != "POOL") %>%
  filter(!npoc_flag %in% "omitted for high dilution and blank values") %>%
  filter(!tdn_flag %in% "omitted for high dilution and blank values") %>%
  filter(!sample_name %in% "Lysimeter Empty") %>%
  summarise(n=n(),
              doc_mg_l_sd = round(sd(doc_mg_l, na.rm = TRUE), 2),
            doc_mg_l = round(mean(doc_mg_l, na.rm = TRUE), 2),
            tdn_mg_l_sd = round(sd(tdn_mg_l, na.rm = TRUE), 2),
            tdn_mg_l = round(mean(tdn_mg_l, na.rm = TRUE),2),
            .groups = "drop") %>%
    arrange(Plot, year, month)

all_eems <- eems %>%
   mutate(date = as.POSIXct(date)) %>%
  mutate(Plot = stringr::str_replace(Plot,"SW","Estuarine-water Plot")) %>%
  mutate(Plot = stringr::str_replace(Plot,"FW","Freshwater Plot")) %>%
  mutate(Plot = stringr::str_replace(Plot,"C","Control Plot")) %>%
  mutate(date_formatted = paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date))) %>%
  mutate(date_formatted = lubridate::as_date(date_formatted)) %>%
  mutate(plot_date = case_when( lubridate::month(date_formatted) == lubridate::month(event_2023) ~ paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date)),
                               lubridate::month(date_formatted) == lubridate::month(event_2023) ~ paste0(lubridate::year(date), "-", lubridate::month(date), "-", lubridate::day(date)),
          TRUE ~  paste0(lubridate::year(date), "-", lubridate::month(date), "-", "01")),
        month = lubridate::month(date),
        year = lubridate::year(date)) %>%
  mutate(plot_date = lubridate::with_tz(plot_date, "UTC")) %>%
  group_by(Plot, plot_date, month, year) %>% 
    arrange(Plot, year, month)
    
# Plotting

Figure X for Take Home Message: There is a prolonged and sustained release of carbon following exposure to salinity.

```{r set up plots}
plot_order <- c('Control Plot', 'Freshwater Plot','Estuarine-water Plot')
Anyas_colors_alpha_order = c("springgreen2", "violetred2", "cyan2")

```

Boxplots and Violins to look at the data distribution: 

```{r plot distribution of data}

pw_plotting %>%
  group_by(Group) %>%
 filter(datetime > WaterDeliveryStop2022 & datetime < WaterDeliveryStart1) %>%
  ggplot() +
  #     # Water 2022
 # annotate("rect", xmin = WaterDeliveryStart2022, xmax = WaterDeliveryStop2022, ymin = -Inf, ymax = Inf, fill = "blue")+
  #  # Water 1
 # annotate("rect", xmin = WaterDeliveryStart1, xmax = WaterDeliveryStop1, ymin = -Inf, ymax = Inf, fill = "blue") +
  # #Water 2
 # annotate("rect", xmin = WaterDeliveryStart2 , xmax = WaterDeliveryStop2, ymin = -Inf, ymax = Inf, fill = "blue") +
  #scale_x_datetime(minor_breaks= waiver(),date_minor_breaks = "1 month", date_breaks="2 months",date_labels= '%b %y')+
  geom_violin(aes(x = factor(Group), y =doc_mg_l, color= plot), drop= FALSE)+
  # geom_line(aes(x = plot_date, y =doc_mg_l, color = Plot))+
  ylab("DOC mgC/L")+
  xlab("Date")+
  ylim(0,100)+
  scale_color_manual(values=Anyas_colors_alpha_order) +
  theme_classic() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         axis.text.x= element_text(size=10, color= "black",angle = 45, hjust = 1)) 
```

```{r timeseries plot}
pw_plotting %>%
  group_by(Group) %>%
  ggplot() +
  #     # Water 2022
 # annotate("rect", xmin = WaterDeliveryStart2022, xmax = WaterDeliveryStop2022, ymin = -Inf, ymax = Inf, fill = "blue")+
  #  # Water 1
 # annotate("rect", xmin = WaterDeliveryStart1, xmax = WaterDeliveryStop1, ymin = -Inf, ymax = Inf, fill = "blue") +
  # #Water 2
 # annotate("rect", xmin = WaterDeliveryStart2 , xmax = WaterDeliveryStop2, ymin = -Inf, ymax = Inf, fill = "blue") +
  #scale_x_datetime(minor_breaks= waiver(),date_minor_breaks = "1 month", date_breaks="2 months",date_labels= '%b %y')+
  geom_boxplot(aes(x = factor(Group), y =doc_mg_l, color= plot), drop= FALSE)+
  # geom_line(aes(x = plot_date, y =doc_mg_l, color = Plot))+
  ylab("DOC mgC/L")+
  xlab("Date")+
  ylim(0,100)+
  scale_color_manual(values=Anyas_colors_alpha_order) +
  theme_classic() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         axis.text.x= element_text(size=10, color= "black",angle = 45, hjust = 1)) 
```
