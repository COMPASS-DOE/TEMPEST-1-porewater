---
title: "Porewater DOC Manuscript Analysis"
author: "AMP"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(lubridate)
library(tidyverse)
library(car)
library(emmeans)
library(lme4)
library(lmerTest)  
library(ggplot2)    # For diagnostic plots
library(broom)      # For tidy model outputs

#double check your wd
getwd()

#clean out your environment 
rm(list = ls())
```

### Set the study dates

```{r event and study dates}
endstudydate = lubridate::as_date("2024-01-31")
startstudydate = lubridate::as_date("2022-05-01")

endstudydate_yr1 = lubridate::as_date("2023-05-31")
startstudydate_yr1 = lubridate::as_date("2022-05-01")

year1_start = lubridate::as_date("2022-01-01")
year1_stop = lubridate::as_date("2022-12-31")

year2_start = lubridate::as_date("2023-01-01")
year2_stop = lubridate::as_date("2023-12-31")

year3_start = lubridate::as_date("2024-01-01")
year3_stop = lubridate::as_date("2024-12-31")

WaterDeliveryStart2022 = as.POSIXct("2022-06-22 05:30:00", tz = "EST")
WaterDeliveryStop2022 = as.POSIXct("2022-06-22 14:30:00", tz = "EST")

WaterDeliveryStart1 = as.POSIXct("2023-06-06 05:30:00", tz = "EST")
WaterDeliveryStop1 = as.POSIXct("2023-06-06 14:30:00", tz = "EST")

WaterDeliveryStart2 = as.POSIXct("2023-06-07 05:30:00", tz = "EST")
WaterDeliveryStop2 = as.POSIXct("2023-06-07 14:30:00", tz = "EST")

plot_order <- c('Control', 'Freshwater','Estuarine-water')
time_order <- c('Pre', 'Mid','Post')
```

## DOC

1) Import DOC grid data for porewater from 2022 and 2023 events. Then, bind them together and take the average and standard deviation of the values for each event. Do this by the evacuation date, as this will capture multiple tries within the same dateframe. For this particular analysis, it's ok to take the average of the date time of sampling, because we're just going to be using this data to plot through time and do some simple summary statistics.  

```{r read in doc}

#Porewater DOC data, from L1 google drive: 

doc_l1_2022 <- read_csv("~/GitHub/TEMPEST-1-porewater/processed data/for_google_drive/TMP_PW_GRIDSONLY_NPOC_TDN_L1_2022.csv")
  
doc_l1_2023 <- read_csv("~/GitHub/TEMPEST-1-porewater/processed data/for_google_drive/TMP_PW_GRIDSONLY_NPOC_TDN_L1_2023.csv")
```

```{r doc avg stds}
doc_l1_pw_grids <- doc_l1_2022 %>%
  full_join(doc_l1_2023) %>%
  select(plot, evacuation_date, collection_datetime, doc_mg_l, tdn_mg_l) %>%
  drop_na() #dont need to specify column here because the only ones with NAs are DOC or TDN and they are both NA at the same time.

#can't get both mean and sd to work across everything for some reason, so calculate separate then recombine. 
# Some dates not enough water was collected to have multiple samples to get averages and sds for that evacuation period. Most of the time, those can be combined with sampling dates just before or just after as we go out over several multi-day periods. This, however isn't consistent across the FW, EW, or C plots, so it will be a bit tricky to do the gap filling. To make the gap filling more accurate, we'll take the average of those dates, so for example if the dates we're merging is 2022-11-25 and 2022-11-28 we'll have the date be the 26th (but we'll let R do that math).

#First, isolate the trouble dates/times: 

#Control: 
mean_doc_l1_c_to_gapfill <- doc_l1_pw_grids %>%
  filter(plot == "Control") %>%
  filter(evacuation_date %in% c("2022-09-09", "2022-09-12", "2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-12-05", "2023-12-08")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "A",
    str_detect(evacuation_date,"2022-11-28") | str_detect(evacuation_date,"2022-11-25") ~ "B",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "C",
    str_detect(evacuation_date,"2023-07-05") | str_detect(evacuation_date,"2023-07-07") ~ "D",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "E",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
    dplyr::summarise(across(everything(), mean), .groups = "keep") %>%
  mutate(collection_datetime = as.POSIXct(collection_datetime, origin = "1970-01-01"),
         evacuation_date = as_date(evacuation_date)) %>%
  ungroup()

sd_doc_l1_c_to_gapfill <- doc_l1_pw_grids %>%
  select(-collection_datetime) %>%
  filter(plot == "Control") %>%
  filter(evacuation_date %in% c("2022-09-09", "2022-09-12", "2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-12-05", "2023-12-08")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "A",
    str_detect(evacuation_date,"2022-11-28") | str_detect(evacuation_date,"2022-11-25") ~ "B",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "C",
    str_detect(evacuation_date,"2023-07-05") | str_detect(evacuation_date,"2023-07-07") ~ "D",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "E",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
    select(-evacuation_date) %>%
    dplyr::summarise(across(everything(), sd), .groups = "keep") %>%
  rename(doc_mg_l_sd = doc_mg_l,
         tdn_mg_l_sd = tdn_mg_l) %>%
    ungroup() 

c_gapfill <- mean_doc_l1_c_to_gapfill %>%
  full_join(sd_doc_l1_c_to_gapfill, by = c("plot", "gapfill_group")) %>%
  select(-gapfill_group)

#Estuarine Water
mean_doc_l1_sw_to_gapfill <- doc_l1_pw_grids %>%
  filter(plot == "Estuarine-water") %>%
  filter(evacuation_date %in% c("2022-07-18", "2022-07-14", "2022-08-08", "2022-08-05","2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-12-05", "2023-12-08", "2023-01-30", "2023-02-02")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-07-18") | str_detect(evacuation_date,"2022-07-14") ~ "A",
    str_detect(evacuation_date,"2022-08-08") | str_detect(evacuation_date,"2022-08-05") ~ "B",
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "C",
    str_detect(evacuation_date,"2022-11-25") | str_detect(evacuation_date,"2022-11-28") ~ "D",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "E",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "F",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
    dplyr::summarise(across(everything(), mean), .groups = "keep") %>%
    ungroup() 

sd_doc_l1_sw_to_gapfill <- doc_l1_pw_grids %>%
  select(-collection_datetime) %>%
  filter(plot == "Estuarine-water") %>%
   filter(evacuation_date %in% c("2022-07-18", "2022-07-14", "2022-08-08", "2022-08-05","2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-12-05", "2023-12-08", "2023-01-30", "2023-02-02")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-07-18") | str_detect(evacuation_date,"2022-07-14") ~ "A",
    str_detect(evacuation_date,"2022-08-08") | str_detect(evacuation_date,"2022-08-05") ~ "B",
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "C",
    str_detect(evacuation_date,"2022-11-25") | str_detect(evacuation_date,"2022-11-28") ~ "D",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "E",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "F",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
    select(-evacuation_date) %>%
    dplyr::summarise(across(everything(), sd), .groups = "keep") %>%
  rename(doc_mg_l_sd = doc_mg_l,
         tdn_mg_l_sd = tdn_mg_l) %>%
    ungroup()

sw_gapfill <- mean_doc_l1_sw_to_gapfill %>%
  full_join(sd_doc_l1_sw_to_gapfill, by = c("plot", "gapfill_group")) %>%
  select(-gapfill_group)

#Freshwater: 
mean_doc_l1_fw_to_gapfill <- doc_l1_pw_grids %>%
  filter(plot == "Freshwater") %>%
  filter(evacuation_date %in% c("2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-09-29", "2023-10-02","2023-12-05", "2023-12-08")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "A",
    str_detect(evacuation_date,"2022-11-28") | str_detect(evacuation_date,"2022-11-25") ~ "B",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "C",
    str_detect(evacuation_date,"2023-07-05") | str_detect(evacuation_date,"2023-07-07") ~ "D",
    str_detect(evacuation_date,"2023-09-29") | str_detect(evacuation_date,"2023-10-02") ~ "E",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "F",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
    dplyr::summarise(across(everything(), mean), .groups = "keep") %>%
    ungroup()

sd_doc_l1_fw_to_gapfill <- doc_l1_pw_grids %>%
  select(-collection_datetime) %>%
  filter(plot == "Freshwater") %>%
  filter(evacuation_date %in% c("2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-09-29", "2023-10-02","2023-12-05", "2023-12-08")) %>%
  mutate(gapfill_group = case_when( 
    str_detect(evacuation_date,"2022-09-09") | str_detect(evacuation_date,"2022-09-12") ~ "A",
    str_detect(evacuation_date,"2022-11-28") | str_detect(evacuation_date,"2022-11-25") ~ "B",
    str_detect(evacuation_date,"2023-01-30") | str_detect(evacuation_date,"2023-02-02") ~ "C",
    str_detect(evacuation_date,"2023-07-05") | str_detect(evacuation_date,"2023-07-07") ~ "D",
    str_detect(evacuation_date,"2023-09-29") | str_detect(evacuation_date,"2023-10-02") ~ "E",
    str_detect(evacuation_date,"2023-12-05") | str_detect(evacuation_date,"2023-12-08") ~ "F",
    TRUE ~ "no")) %>%
   group_by(plot, gapfill_group) %>%
  select(-evacuation_date) %>%
    dplyr::summarise(across(everything(), sd), .groups = "keep") %>%
 # mutate(evacuation_date = as_date(evacuation_date))%>%
  rename(doc_mg_l_sd = doc_mg_l,
         tdn_mg_l_sd = tdn_mg_l) %>%
    ungroup() 

fw_gapfill <- mean_doc_l1_fw_to_gapfill %>%
  full_join(sd_doc_l1_fw_to_gapfill, by = c("plot", "gapfill_group")) %>%
  select(-gapfill_group)


#All the rest: 
means_doc_l1_pw_grids <- doc_l1_pw_grids %>%
filter(plot != "Control" | 
    (plot == "Control" & !evacuation_date %in% as.Date(c("2022-09-09", "2022-09-12", "2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-12-05", "2023-12-08")))) %>%
  filter(plot != "Estuarine-water" | 
    (plot == "Estuarine-water" & !evacuation_date %in% as.Date(c("2022-07-18", "2022-07-14", "2022-08-08", "2022-08-05","2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-12-05", "2023-12-08", "2023-01-30", "2023-02-02")))) %>%
    filter(plot != "Freshwater" | 
    (plot == "Freshwater" & !evacuation_date %in% as.Date(c("2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-09-29", "2023-10-02","2023-12-05", "2023-12-08")))) %>%
  mutate(evacuation_date = as.numeric(evacuation_date),
         collection_datetime= as.numeric(collection_datetime)) %>%
  group_by(plot, evacuation_date) %>%
  dplyr::summarise(across(everything(), mean), .groups = "keep") %>%
  mutate(collection_datetime = as.POSIXct(collection_datetime, origin = "1970-01-01"),
         evacuation_date = as_date(evacuation_date))


sds_doc_l1_pw_grids <- doc_l1_pw_grids %>%
  select(-collection_datetime) %>%
 filter(plot != "Control" | 
    (plot == "Control" & !evacuation_date %in% as.Date(c("2022-09-09", "2022-09-12", "2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-12-05", "2023-12-08")))) %>%
  filter(plot != "Estuarine-water" | 
    (plot == "Estuarine-water" & !evacuation_date %in% as.Date(c("2022-07-18", "2022-07-14", "2022-08-08", "2022-08-05","2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-12-05", "2023-12-08", "2023-01-30", "2023-02-02"))))  %>%
    filter(plot != "Freshwater" | 
    (plot == "Freshwater" & !evacuation_date %in% as.Date(c("2022-09-09", "2022-09-12","2022-11-28", "2022-11-25", "2023-01-30", "2023-02-02", "2023-07-05", "2023-07-07", "2023-09-29", "2023-10-02","2023-12-05", "2023-12-08")))) %>%
  mutate(evacuation_date = as.numeric(evacuation_date)) %>%
  group_by(plot, evacuation_date) %>%
  dplyr::summarise(across(everything(), sd), .groups = "keep") %>%
  mutate(evacuation_date = as_date(evacuation_date)) %>%
  rename(doc_mg_l_sd = doc_mg_l,
         tdn_mg_l_sd = tdn_mg_l)

merging_dfs <- list(means_doc_l1_pw_grids, sds_doc_l1_pw_grids, c_gapfill, sw_gapfill, fw_gapfill)

pw_doc <- purrr::reduce(merging_dfs, full_join)

# write out for plotting:
saveRDS(pw_doc, "~/GitHub/TEMPEST-1-porewater/data/averaged_doc_porewater.rds")
```
### run stats for DOC: 

First source the functions from TSLA:

```{r tsla functions}

# set event window to use for all data frame function calls
flood_event_date <- c(as_date("2022-06-22"))

# set event window to use for all data frame function calls
flood_event_datetime <- c(as_datetime("2022-06-22 5:30:00", tz = "EST"), as_datetime("2022-06-22 14:30:00", tz = "EST"))

EVENT_START <- as_datetime("2022-06-22 05:30:00", tz = "EST")
EVENT_STOP <- as_datetime("2022-06-22 14:30:00", tz = "EST")

STUDY_START <- as_datetime("2022-05-01 00:00:00", tz = "EST")

STUDY_END <- as_datetime("2023-05-31 00:00:00", tz = "EST")

source("~/GitHub/tempest-system-level-analysis/scripts/tmp_test_functions.R")

# check them out: 
calc_dist_metrics

```

```{r baci functions}
source("~/GitHub/TEMPEST-1-porewater/scripts/analysis_scripts/BACI_stats_function_fromDivideData.R")

```

```{r doc baci stats}
doc_baci_sw_2022 <- doc_l1_pw_grids %>%
    filter(collection_datetime < endstudydate & collection_datetime > startstudydate) %>%
    divide_data(collection_datetime,flood_event_datetime)
#  baci_stats(var = doc_mg_l, plot = "Estuarine-water",  p_value_threshold = 0.05)

```


[insert some version of BACI stats here]

## OM Chemistry

```{r load fticrms}
# load data
pw_ft <- read_rds("~/GitHub/TEMPEST-1-porewater/processed data/TMP_PW_FTICRMS_L1_May2022-May2023.rds") %>%
  mutate(datetime_est = force_tz(collection_datetime, tzone = "EST")) %>% 
   group_by(Event, plot, grid, date, sample_name, Class_detailed) %>%
    dplyr::summarise(abund = sum(presence))  %>%
    ungroup() %>% 
    # create a new column for total counts per core assignment
    # and then calculate relative abundance  
    group_by(Event, plot, grid, date, sample_name) %>% 
    dplyr::mutate(total = sum(abund),
                  relabund  = round((abund/total)*100,2)) %>%
  ungroup() %>%
  dplyr::select(date, plot, Class_detailed, relabund) %>% 
  group_by(date, plot, Class_detailed) %>%
  zscore_standard(vars = "relabund") %>% ungroup()

pw_ft %>% summary()

```

```{r tsla metrics}
#assign timepoints and write out for various plotting efforts
timepoints_fticrms <- divide_data(pw_ft, date, flood_event_date)   

dates_fticrms_avg <- timepoints_fticrms %>%
  group_by(plot, Class_detailed, date, timedate_bin) %>%
  summarize(relabund_mean = mean(relabund), relabund_sd = sd(relabund)) %>%
  mutate(plot = case_when(plot == "FW" ~ "Freshwater",
                          plot == "SW" ~ "Estuarine-water",
                          plot == "C" ~ "Control",
                          TRUE ~ plot))

# write out for plotting:
saveRDS(dates_fticrms_avg, "~/GitHub/TEMPEST-1-porewater/data/avg_relabund_dates_fticrms_porewater.rds")


sum_fticrms <- timepoints_fticrms%>%
  group_by(plot, Class_detailed, timedate_bin) %>%
  summarize(relabund_mean = mean(relabund), relabund_sd = sd(relabund)) %>%
  mutate(plot = case_when(plot == "FW" ~ "Freshwater",
                          plot == "SW" ~ "Estuarine-water",
                          plot == "C" ~ "Control",
                          TRUE ~ plot))

# write out for plotting:
saveRDS(sum_fticrms, "~/GitHub/TEMPEST-1-porewater/data/avg_relativeabundance_premidpost_fticrms_porewater.rds")
```

# OM chemistry stats

Stats for aromatic content in FTICRMS signal:
Trying a simple repeated measures anova first: 
```{r anova aromatic fticrms}

dates_fticrms_avg_stats <- dates_fticrms_avg %>%
  mutate(plot = factor(plot, levels = plot_order),
         timedate_bin = factor(timedate_bin, levels = time_order)) %>%
filter(Class_detailed == "highly aromatic")

lmm_res <- lmer(relabund_mean ~ plot + (1|timedate_bin), data = dates_fticrms_avg_stats )
summary(lmm_res)
  
```


