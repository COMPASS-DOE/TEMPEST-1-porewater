---
title: "TEROS data prep"
author: "PR Modified by AMP"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      message = F,
                      warning = F)

common_tz = "Etc/GMT+5"
```

### General purpose

R markdown for the TEROS data for the project. 

```{r Setup}
## First, load setup script to set up environment
pacman::p_load(tidyverse, 
       #rdrop2, 
       cowplot, 
       lubridate, 
       #ggtukey, # adding letters to boxplots
      # multcompView, # compact letter display for comparing boxplots
       plotly,
       parsedate, # parse_date()
       janitor, # clean_names()
       purrr, # map()
       furrr,  # future_map()
       tictoc, # time stuff
       sf, 
       hms,
       ggallin,
       ggpubr, #stat_compare_means()
       #metR, # geom_contour_fill
       rnaturalearth,
       ggspatial, # north arrow and compass
       googledrive, 
       ggthemes) #theme_map()
```

```{r data setup}
raw_data_path <- "./data_do_not_commit/teros/"

l1_2022_file_list <- drive_ls("https://drive.google.com/drive/folders/1z-ecWwa7Xa2pbGOl6rZEW6p8RbLL8QdX", 
                      pattern = ".csv")

l1_2023_file_list <- drive_ls("https://drive.google.com/drive/folders/1-ebNwEWViTIo2fb6fmPryfXJmD_VmHsK", 
                      pattern = ".csv")

getwd()
```

If you need to download the data, this is how you can do it. If not, SKIP this chunk (eval = F). 

```{r Pull L1 data from Gdrive, eval = F}

drive_download_ <- function(data){
  #message(paste("Downloading", data$name))
  # you could add an ifelse to only download files it doesn't fine in raw_data_path
  drive_download(data$id, overwrite = T, path = paste0(raw_data_path, data$name))
}

## Use a for-loop to read in files in a way that I can see what's going on
## Download data to local. I tried to map() but for some reasons it doesn't work?
for(i in 1:nrow(l1_2022_file_list)){
  drive_download_(l1_2022_file_list %>% slice(i))
}

for(i in 1:nrow(l1_2023_file_list)){
  drive_download_(l1_2023_file_list %>% slice(i))
}
```

#### QC Step 1: Remove flagged values

```{r Read in L1 data, message=FALSE, warning=FALSE}

read_data <- function(name){
  read_csv(paste0(raw_data_path, name)) %>% 
  clean_names() %>% 
  filter(str_detect(research_name, "soil_vwc") | str_detect(research_name, "soil_EC") | str_detect(research_name, "wx_rain")) %>% #pull the teros vwc, EC, and the rain data
    #Rain data isn't getting pulled in this way for some reason...
  mutate(datetime_est = force_tz(timestamp, tzone = common_tz), 
         depth = str_extract(research_name, "\\d+(?=cm)"),
         plot = case_when(plot == "C" ~ "Control", 
                          plot == "S" ~ "Estuarine-water", 
                          plot == "FALSE" ~ "Freshwater")) %>% #for some reason the FW files are coming in with FALSE not F
    filter(f_oob == 0) %>% #filters out flag, Flag: out of instrumental bounds (logical; 1=TRUE)
  dplyr::select(datetime_est, research_name, plot, location, depth, sensor_id, value, contains("f_")) 
}

##Bind data together and filter out the data we definitely won't need.
teros_2022_raw <- l1_2022_file_list$name %>% 
  map(read_data) %>% 
  bind_rows() 

teros_2023_raw <- l1_2023_file_list$name %>% 
  map(read_data) %>% 
  bind_rows() 

teros_all_raw <- teros_2022_raw %>%
  full_join(teros_2023_raw)
```

### Raw data

```{r filter to pw grids}
pwsite_key <- readxl::read_excel("../tempest-system-level-analysis/data/for processing/porewater_sites_complete_key.xlsx") %>%
  select(Plot, Grid) %>%
  unique() %>%
  rename(plot = Plot,
         location = Grid) %>%
  mutate( plot = case_when(plot == "C" ~ "Control", 
                          plot == "SW" ~ "Estuarine-water", 
                          plot == "FW" ~ "Freshwater"))

grids <- pwsite_key %>%
  dplyr::distinct(location)

```

Rain only lives in GCW-W: https://github.com/COMPASS-DOE/data-workflows/issues/158

```{r rain}

rain_qc1 <- teros_all_raw %>% 
  filter(research_name == "wx_rain24")
```

Remove the teros where we don't have lysimeters
and filter out when lysimeter is out of service 

```{r qc1}

teros_qc1 <- teros_all_raw %>% 
  filter((location %in% grids$location)) %>%
  mutate(variable = str_extract(research_name, "(?<=_)[^_]+(?=_)")) %>%
      filter(f_oos == 0) #filters out flag, Flag: sensor listed as out of service (logical; 1=TRUE)
```

Let's first take a look at all the raw data. 

```{r}
## Plotly plot to look at individual sensors
p <- teros_qc1 %>%
  filter(variable == "vwc") %>%
  ggplot(aes(datetime_est, value, linetype= location, color = depth)) + 
  geom_line() + 
  facet_wrap(~plot, ncol = 1)

 ggplotly(p)
```
Notes from the ggplotly, *I5 at 15cm deep* in SW plot looks funky 2023-01-04 13:00 to 2023-05-31 13:00 - ie. reading the same value all winter: 0.3
Everybody else is following roughly the same trend.

```{r scrub the sketch}
teros_qc2 <- teros_qc1 %>% 
  mutate(value = case_when(research_name == "soil_vwc_15cm" & location == "I5" & between(datetime_est, as.POSIXct("2023-01-04 13:00", tz = common_tz), as.POSIXct("2023-05-31 13:00", tz = common_tz)) ~ NA,
                           TRUE ~ value))
```

Write out VWC for flux calculations:

```{r vwc for fluxes}

vwc_L2 <- teros_qc2 %>%
  filter(depth != "30") %>%
  filter(variable == "vwc") %>%
  rename(vwc_m3m3 = value,
         grid = location) %>%
  select(datetime_est, plot, grid, depth, research_name, vwc_m3m3) %>%
  mutate(plot = case_when(plot == "Estuarine" ~ "Estuarine-water",
                          TRUE ~ plot))
  
print(vwc_L2)

write_csv(vwc_L2, "../TEMPEST-1-porewater/processed data/TMP_PW_L2_VWC_2022-2023.csv")

saveRDS(vwc_L2, "../TEMPEST-1-porewater/processed data/TMP_PW_L2_VWC_2022-2023.rds")
  
```

EC for ionic strength:

```{r ec}
## Plotly plot to look at individual sensors
p <- teros_qc1 %>%
  filter(variable == "EC") %>%
  ggplot(aes(datetime_est, value, linetype= location, color = depth)) + 
  geom_line() + 
  facet_wrap(~plot, ncol = 1)

 ggplotly(p)
```
there are some crazy things happening in the control plot H6:
peaks with one data point really high SPC in the 5cm sensor at H6
"2022-02-20 22:30"
"2022-02-21 09:00"
"2022-12-03 13:45"
"2023-02-25 02:00"
"2023-02-27 04:15"
"2023-03-01 01:30"
"2023-03-01 08:00"
"2023-12-09 05:45"
"2023-12-13 02:30"
"2023-12-13 21:15"



```{r scrub the sketch 2}
teros_qc2 <- teros_qc1 %>% 
  mutate(value = case_when(research_name == "soil_EC_5cm" & location == "H6" & datetime_est %in% as.POSIXct(c("2022-02-20 22:30", "2022-02-21 09:00", "2022-12-03 13:45", 
                                   "2023-02-25 02:00", "2023-02-27 04:15", "2023-03-01 01:30", 
                                   "2023-03-01 08:00", "2023-12-09 05:45", "2023-12-13 02:30", 
                                   "2023-12-13 21:15"), tz = common_tz)  ~ NA,
                           TRUE ~ value))
```

```{r EC for fluxes}

EC_L2 <- teros_qc2 %>%
  filter(depth != "30") %>%
  filter(variable == "EC") %>%
  rename(EC_uScm = value,
         grid = location) %>%
  select(datetime_est, plot, grid, depth, research_name, EC_uScm) %>%
  mutate(plot = case_when(plot == "Estuarine" ~ "Estuarine-water",
                          TRUE ~ plot))
  
print(EC_L2)

write_csv(EC_L2, "../TEMPEST-1-porewater/processed data/TMP_PW_L2_EC_2022-2023.csv")

saveRDS(EC_L2, "../TEMPEST-1-porewater/processed data/TMP_PW_L2_EC_2022-2023.rds")
  
```
